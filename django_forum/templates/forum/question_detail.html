{% extends 'base.html' %}
{% load static %}
{% load votes_tags %}
{% load i18n %}

{% block title %}{{ question.title }} - {% trans "Night Coder" %}{% endblock %}

{% block main_class %}bg-dark{% endblock %}

{% block content %}
<!-- Header with Back Button -->
<section class="night-gradient text-white py-3 py-md-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'forum:question_list' %}" class="btn btn-outline-light btn-sm mb-2">
                    ‚Üê {% trans "Back to All Questions" %}
                </a>
                <h1 class="h4 h3-md mb-0">üí¨ {% trans "Question Details" %}</h1>
            </div>
            {% if user.is_authenticated and user != question.author %}
            <a href="#answer-form" class="btn btn-warning btn-sm">
                üí° {% trans "Answer Question" %}
            </a>
            {% endif %}
        </div>
    </div>
</section>

<div class="container py-4 py-md-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-12">
            <!-- Question Card -->
            <div class="card professional-card border-0 shadow-lg mb-4">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start">
                        <!-- Voting Widget with js queries -->
                        <div class="me-3 me-md-4 text-center">
                            <div class="vote-widget d-flex flex-column align-items-center">
                                <!-- Upvote Button -->
                                <button class="btn btn-sm btn-outline-success border-0 p-1 vote-btn {% if question.user_vote == 'up' %}active btn-success text-white{% endif %}"
                                        data-content-type="{% get_content_type_id question %}"
                                        data-object-id="{{ question.id }}"
                                        data-vote-type="up"
                                        {% if not user.is_authenticated or user == question.author %}disabled{% endif %}
                                        title="{% if user == question.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Upvote (+5 reputation)" %}{% endif %}">
                                    <span style="font-size: 1.2em;">‚¨ÜÔ∏è</span>
                                </button>

                                <!-- Vote Count -->
                                <span class="my-2 fw-bold fs-4 {% if question.vote_count > 0 %}text-success{% elif question.vote_count < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ question.vote_count }}
                                </span>

                                <!-- Downvote Button -->
                                <button class="btn btn-sm btn-outline-danger border-0 p-1 vote-btn {% if question.user_vote == 'down' %}active btn-danger text-white{% endif %}"
                                        data-content-type="{% get_content_type_id question %}"
                                        data-object-id="{{ question.id }}"
                                        data-vote-type="down"
                                        {% if not user.is_authenticated or user == question.author %}disabled{% endif %}
                                        title="{% if user == question.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Downvote (-2 reputation)" %}{% endif %}">
                                    <span style="font-size: 1.2em;">‚¨áÔ∏è</span>
                                </button>

                                <small class="text-muted text-center mt-2">
                                    {{ question.upvotes }}‚Üë / {{ question.downvotes }}‚Üì
                                </small>
                            </div>
                        </div>

                        <!-- Question Content -->
                        <div class="flex-grow-1">
                            <!-- Question Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h1 class="h3 h2-md text-light mb-2">{{ question.title }}</h1>
                                    {% if question.is_solved %}
                                    <span class="badge bg-success mb-2">‚úÖ {% trans "Solved" %}</span>
                                    {% endif %}
                                </div>
                                {% if user == question.author %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        ‚öôÔ∏è {% trans "Actions" %}
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'forum:question_update' question.pk %}">
                                                ‚úèÔ∏è {% trans "Edit Question" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="{% url 'forum:question_delete' question.pk %}">
                                                üóëÔ∏è {% trans "Delete Question" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Question Meta -->
                            <div class="d-flex flex-wrap gap-3 text-muted small mb-4">
                                <span class="d-flex align-items-center">
                                    üë§ <strong class="ms-1">{{ question.author.username }}</strong>
                                </span>
                                <span class="d-flex align-items-center">
                                    üèÜ {{ question.author.profile.reputation_points }} {% trans "rep" %}
                                </span>
                                <span class="d-flex align-items-center">
                                    üìÖ {{ question.created_at|timesince }} {% trans "ago" %}
                                </span>
                                {% if question.updated_at != question.created_at %}
                                <span class="d-flex align-items-center">
                                    ‚úèÔ∏è {% trans "Edited" %} {{ question.updated_at|timesince }} {% trans "ago" %}
                                </span>
                                {% endif %}
                            </div>

                            <!-- Question Body -->
                            <div class="question-content text-light mb-4">
                                {{ question.content|linebreaks }}
                            </div>

                            <!-- Question Tags -->
                            {% if question.tags.all %}
                            <div class="mb-3">
                                {% for tag in question.tags.all %}
                                <span class="badge bg-secondary me-1">üè∑Ô∏è {{ tag.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Answers Section -->
            <div class="card professional-card border-0 shadow-lg">
                <div class="card-header professional-card-header d-flex justify-content-between align-items-center p-3">
                    <h4 class="mb-0 h5 h4-md">
                        üí¨ {% trans "Answers" %} ({{ answers.count }})
                    </h4>
                    <div class="text-warning small">
                        {% if question.is_solved %}‚úÖ {% trans "Solved" %}{% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% for answer in answers %}
                    <div class="border-bottom border-dark p-3 p-md-4 {% if answer.is_accepted %}bg-success bg-opacity-10{% endif %}">
                        <div class="d-flex align-items-start">
                            <!-- Answer Voting -->
                            <div class="me-3 me-md-4 text-center">
                                <div class="vote-widget d-flex flex-column align-items-center">
                                    <!-- Upvote Button -->
                                    <button class="btn btn-sm btn-outline-success border-0 p-1 vote-btn {% if answer.user_vote == 'up' %}active btn-success text-white{% endif %}"
                                            data-content-type="{% get_content_type_id answer %}"
                                            data-object-id="{{ answer.id }}"
                                            data-vote-type="up"
                                            {% if not user.is_authenticated or user == answer.author %}disabled{% endif %}
                                            title="{% if user == answer.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Upvote (+10 reputation)" %}{% endif %}">
                                        <span style="font-size: 1.2em;">‚¨ÜÔ∏è</span>
                                    </button>

                                    <!-- Vote Count -->
                                    <span class="my-2 fw-bold fs-4 {% if answer.vote_count > 0 %}text-success{% elif answer.vote_count < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {{ answer.vote_count }}
                                    </span>

                                    <!-- Downvote Button -->
                                    <button class="btn btn-sm btn-outline-danger border-0 p-1 vote-btn {% if answer.user_vote == 'down' %}active btn-danger text-white{% endif %}"
                                            data-content-type="{% get_content_type_id answer %}"
                                            data-object-id="{{ answer.id }}"
                                            data-vote-type="down"
                                            {% if not user.is_authenticated or user == answer.author %}disabled{% endif %}
                                            title="{% if user == answer.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Downvote (-2 reputation)" %}{% endif %}">
                                        <span style="font-size: 1.2em;">‚¨áÔ∏è</span>
                                    </button>

                                    <small class="text-muted text-center mt-2">
                                        {{ answer.upvotes }}‚Üë / {{ answer.downvotes }}‚Üì
                                    </small>

                                    <!-- Accept Answer Button -->
                                    {% if user == question.author %}
                                        {% if not answer.is_accepted %}
                                        <button class="btn btn-sm btn-outline-success border-0 p-1 mt-2 accept-answer"
                                                data-answer-id="{{ answer.id }}"
                                                data-accept-url="{% url 'forum:answer_accept' answer.id %}"
                                                title="{% trans "Mark as accepted answer (+15 reputation)" %}">
                                            ‚úÖ {% trans "Accept" %}
                                        </button>
                                        {% else %}
                                        <div class="mt-2 text-success" title="{% trans "Accepted answer" %}">
                                            ‚úÖ {% trans "Accepted" %}
                                        </div>
                                        {% endif %}
                                    {% elif answer.is_accepted %}
                                    <div class="mt-2 text-success" title="{% trans "Accepted answer" %}">
                                        ‚úÖ {% trans "Accepted" %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Answer Content -->
                            <div class="flex-grow-1">
                                {% if answer.is_accepted %}
                                <div class="badge bg-success mb-3">‚úÖ {% trans "Accepted Answer" %}</div>
                                {% endif %}

                                <div class="answer-content text-light mb-3">
                                    {{ answer.content|linebreaks }}
                                </div>

                                <div class="d-flex justify-content-between align-items-center text-muted small">
                                    <div class="d-flex flex-wrap gap-3">
                                        <span class="d-flex align-items-center">
                                            üë§ {{ answer.author.username }}
                                        </span>
                                        <span class="d-flex align-items-center">
                                            üèÜ {{ answer.author.profile.reputation_points }} {% trans "rep" %}
                                        </span>
                                        <span class="d-flex align-items-center">
                                            üìÖ {{ answer.created_at|timesince }} {% trans "ago" %}
                                        </span>
                                    </div>

                                    {% if user == answer.author %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            ‚öôÔ∏è
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark">
                                            <li>
                                                <a class="dropdown-item" href="{% url 'forum:answer_update' answer.pk %}">
                                                    ‚úèÔ∏è {% trans "Edit" %}
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="{% url 'forum:answer_delete' answer.pk %}">
                                                    üóëÔ∏è {% trans "Delete" %}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <h5>{% trans "No answers yet" %}</h5>
                        <p class="mb-0">{% trans "Be the first to help solve this problem!" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Answer Form -->
            {% if user.is_authenticated %}
            <div class="card professional-card border-0 shadow-lg mt-4" id="answer-form">
                <div class="card-header professional-card-header p-3">
                    <h5 class="mb-0 h6 h5-md">üí° {% trans "Your Answer" %}</h5>
                </div>
                <div class="card-body p-3 p-md-4">
                    <form method="post" action="{% url 'forum:answer_create' question.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ answer_form.content }}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {% trans "Be specific and include any code examples if relevant" %}
                            </small>
                            <button type="submit" class="btn btn-warning fw-bold">
                                üì§ {% trans "Post Answer" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="card professional-card border-0 shadow-lg mt-4">
                <div class="card-body text-center p-4">
                    <i class="fas fa-sign-in-alt fa-2x text-warning mb-3"></i>
                    <h5 class="text-light mb-3">{% trans "Join the Discussion" %}</h5>
                    <p class="text-light-50 mb-3">
                        {% trans "Sign in to post your answer and help solve this problem." %}
                    </p>
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-warning me-2">
                        üîë {% trans "Login" %}
                    </a>
                    <a href="{% url 'users:signup' %}" class="btn btn-outline-light">
                        üöÄ {% trans "Sign Up" %}
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current language prefix from URL
    const currentPath = window.location.pathname;
    let langPrefix = '';

    // Extract language prefix
    if (currentPath.startsWith('/ru/')) {
        langPrefix = '/ru';
    } else if (currentPath.startsWith('/en/')) {
        langPrefix = '/en';
    }
    // Add more languages as needed

    // CSRF token helper function
    function getCSRFToken() {
        const csrfToken = '{{ csrf_token }}';
        if (csrfToken && csrfToken !== 'None') {
            return csrfToken;
        }
        // Fallback: try to get from cookie
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCSRFToken();

    // Voting functionality
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function() {
            const contentType = this.dataset.contentType;
            const objectId = this.dataset.objectId;
            const voteType = this.dataset.voteType;

            // Include language prefix in the URL
            const voteUrl = `${langPrefix}/votes/${contentType}/${objectId}/${voteType}/`;

            fetch(voteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while voting. Please try again.');
            });
        });
    });

    // Accept answer functionality
    document.querySelectorAll('.accept-answer').forEach(button => {
        button.addEventListener('click', function() {
            const answerId = this.dataset.answerId;
            const acceptUrl = this.dataset.acceptUrl;

            fetch(acceptUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while accepting the answer. Please try again.');
            });
        });
    });
});
</script>

<style>
.professional-card {
    background-color: #2a2d3e;
    border: 1px solid #3a3f5c;
    color: #e9ecef;
    transition: all 0.3s ease;
}

.professional-card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.professional-card-header {
    background-color: #343a50 !important;
    border-bottom: 1px solid #3a3f5c;
    color: #ffffff;
}

.vote-widget {
    min-width: 70px;
}

.vote-btn {
    transition: all 0.2s ease;
    border-radius: 0.375rem;
}

.vote-btn:hover:not(:disabled) {
    transform: scale(1.1);
}

.vote-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.vote-btn.active {
    border-width: 2px !important;
}

.night-gradient {
    background: linear-gradient(135deg, #1a1e2e 0%, #2d3748 100%);
}

@media (max-width: 768px) {
    .h2-md {
        font-size: 1.5rem;
    }

    .h4-md {
        font-size: 1.25rem;
    }

    .h5-md {
        font-size: 1.1rem;
    }

    .vote-widget {
        min-width: 60px;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-3 {
        gap: 1rem !important;
    }
}
</style>
{% endblock %}