{% extends 'base.html' %}
{% load static %}
{% load votes_tags %}
{% load i18n %}

{% block title %}{{ review.title }} - {% trans "Night Coder" %}{% endblock %}

{% block main_class %}bg-dark{% endblock %}

{% block content %}
<!-- Header with Back Button -->
<section class="night-gradient text-white py-3 py-md-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'reviews:review_list' %}" class="btn btn-outline-light btn-sm mb-2">
                    ‚Üê {% trans "Back to All Reviews" %}
                </a>
                <h1 class="h4 h3-md mb-0">‚≠ê {% trans "Review Details" %}</h1>
            </div>
            {% if user.is_authenticated %}
            <a href="{% url 'reviews:review_create' %}" class="btn btn-warning btn-sm">
                ‚úçÔ∏è {% trans "Write Review" %}
            </a>
            {% endif %}
        </div>
    </div>
</section>

<div class="container py-4 py-md-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-12">
            <!-- Review Card -->
            <div class="card professional-card border-0 shadow-lg mb-4">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start">
                        <!-- Voting Widget with js queries -->
                        <div class="me-3 me-md-4 text-center">
                            <div class="vote-widget d-flex flex-column align-items-center">
                                <!-- Upvote Button -->
                                <button class="btn btn-sm btn-outline-success border-0 p-1 vote-btn {% if review.user_vote == 'up' %}active btn-success text-white{% endif %}"
                                        data-content-type="{% get_content_type_id review %}"
                                        data-object-id="{{ review.id }}"
                                        data-vote-type="up"
                                        {% if not user.is_authenticated or user == review.author %}disabled{% endif %}
                                        title="{% if user == review.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Upvote this review" %}{% endif %}">
                                    <span style="font-size: 1.2em;">‚¨ÜÔ∏è</span>
                                </button>

                                <!-- Vote Count -->
                                <span class="my-2 fw-bold fs-4 {% if review.vote_count > 0 %}text-success{% elif review.vote_count < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ review.vote_count }}
                                </span>

                                <!-- Downvote Button -->
                                <button class="btn btn-sm btn-outline-danger border-0 p-1 vote-btn {% if review.user_vote == 'down' %}active btn-danger text-white{% endif %}"
                                        data-content-type="{% get_content_type_id review %}"
                                        data-object-id="{{ review.id }}"
                                        data-vote-type="down"
                                        {% if not user.is_authenticated or user == review.author %}disabled{% endif %}
                                        title="{% if user == review.author %}{% trans "Can't vote on your own content" %}{% elif not user.is_authenticated %}{% trans "Login to vote" %}{% else %}{% trans "Downvote this review" %}{% endif %}">
                                    <span style="font-size: 1.2em;">‚¨áÔ∏è</span>
                                </button>

                                <small class="text-muted text-center mt-2">
                                    {{ review.upvotes }}‚Üë / {{ review.downvotes }}‚Üì
                                </small>
                            </div>
                        </div>

                        <!-- Review Content -->
                        <div class="flex-grow-1">
                            <!-- Review Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h1 class="h3 h2-md text-light mb-2">{{ review.title }}</h1>
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="text-warning h5 mb-0 me-2">{{ review.rating }}/5</span>
                                        <div class="text-warning">
                                            {{ review.get_rating_stars }}
                                        </div>
                                    </div>
                                </div>
                                {% if user == review.author %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        ‚öôÔ∏è {% trans "Actions" %}
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'reviews:review_update' review.pk %}">
                                                ‚úèÔ∏è {% trans "Edit Review" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="{% url 'reviews:review_delete' review.pk %}">
                                                üóëÔ∏è {% trans "Delete Review" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Course Info -->
                            <div class="mb-4">
                                <h5 class="text-info mb-2">
                                    üìñ {{ review.course_name }}
                                </h5>
                            </div>

                            <!-- Review Meta -->
                            <div class="d-flex flex-wrap gap-3 text-muted small mb-4">
                                <span class="d-flex align-items-center">
                                    üë§ <strong class="ms-1">{{ review.author.username }}</strong>
                                </span>
                                <span class="d-flex align-items-center">
                                    üèÜ {{ review.author.profile.reputation_points }} {% trans "rep" %}
                                </span>
                                <span class="d-flex align-items-center">
                                    üìÖ {{ review.created_at|timesince }} {% trans "ago" %}
                                </span>
                                {% if review.updated_at != review.created_at %}
                                <span class="d-flex align-items-center">
                                    ‚úèÔ∏è {% trans "Edited" %} {{ review.updated_at|timesince }} {% trans "ago" %}
                                </span>
                                {% endif %}
                            </div>

                            <!-- Review Body -->
                            <div class="review-content text-light mb-4">
                                {{ review.content|linebreaks }}
                            </div>

                            <!-- Helpful Info -->
                            <div class="alert alert-dark border-secondary mt-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle text-info me-2"></i>
                                    <small class="text-light-50">
                                        {% blocktrans %}Was this review helpful? <strong class="text-warning">{{ review.vote_count }}</strong> developers found it useful.{% endblocktrans %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Author's Other Reviews -->
            <div class="card professional-card border-0 shadow-lg">
                <div class="card-header professional-card-header p-3">
                    <h5 class="mb-0 h6 h5-md">
                        üë§ {% blocktrans %}More Reviews by {{ review.author.username }}{% endblocktrans %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% for other_review in author_other_reviews %}
                    {% if other_review.id != review.id %}
                    <div class="border-bottom border-dark p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-2">
                                <h6 class="mb-1 small">
                                    <a href="{% url 'reviews:review_detail' other_review.pk %}"
                                       class="text-decoration-none text-light hover-underline">
                                        {{ other_review.title }}
                                    </a>
                                </h6>
                                <p class="text-info small mb-1">üìñ {{ other_review.course_name }}</p>
                                <div class="text-warning small mb-1">{{ other_review.get_rating_stars }}</div>
                                <div class="text-muted small">
                                    <span class="d-block d-sm-inline">üìÖ {{ other_review.created_at|timesince }} {% trans "ago" %}</span>
                                    <span class="d-none d-sm-inline mx-2">‚Ä¢</span>
                                    <span class="d-block d-sm-inline">üëç {{ other_review.vote_count }} {% trans "votes" %}</span>
                                </div>
                            </div>
                            <div class="text-end flex-shrink-0">
                                <span class="badge bg-warning">{{ other_review.rating }}/5</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        <p class="mb-0">{% trans "No other reviews from this author yet." %}</p>
                    </div>
                    {% endfor %}
                    {% if author_other_reviews.count > 1 %}
                    <div class="text-center p-3">
                        <a href="{% url 'reviews:user_reviews' review.author.username %}"
                           class="btn btn-sm btn-outline-warning w-100">
                            {% blocktrans %}View All Reviews by {{ review.author.username }}{% endblocktrans %}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current language prefix from URL
    const currentPath = window.location.pathname;
    let langPrefix = '';

    // Extract language prefix
    if (currentPath.startsWith('/ru/')) {
        langPrefix = '/ru';
    } else if (currentPath.startsWith('/en/')) {
        langPrefix = '/en';
    }
    // Add more languages as needed

    // CSRF token helper function
    function getCSRFToken() {
        const csrfToken = '{{ csrf_token }}';
        if (csrfToken && csrfToken !== 'None') {
            return csrfToken;
        }
        // Fallback: try to get from cookie
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCSRFToken();

    // Voting functionality
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function() {
            const contentType = this.dataset.contentType;
            const objectId = this.dataset.objectId;
            const voteType = this.dataset.voteType;

            // Include language prefix in the URL
            const voteUrl = `${langPrefix}/votes/${contentType}/${objectId}/${voteType}/`;

            fetch(voteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('{% trans "Error:" %} ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "An error occurred while voting. Please try again." %}');
            });
        });
    });
});
</script>

<style>
.professional-card {
    background-color: #2a2d3e;
    border: 1px solid #3a3f5c;
    color: #e9ecef;
    transition: all 0.3s ease;
}

.professional-card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.professional-card-header {
    background-color: #343a50 !important;
    border-bottom: 1px solid #3a3f5c;
    color: #ffffff;
}

.vote-widget {
    min-width: 70px;
}

.vote-btn {
    transition: all 0.2s ease;
    border-radius: 0.375rem;
}

.vote-btn:hover:not(:disabled) {
    transform: scale(1.1);
}

.vote-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.vote-btn.active {
    border-width: 2px !important;
}

.night-gradient {
    background: linear-gradient(135deg, #1a1e2e 0%, #2d3748 100%);
}

.hover-underline:hover {
    text-decoration: underline !important;
}

.alert-dark {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: #3a3f5c;
}

@media (max-width: 768px) {
    .h2-md {
        font-size: 1.5rem;
    }

    .h4-md {
        font-size: 1.25rem;
    }

    .h5-md {
        font-size: 1.1rem;
    }

    .vote-widget {
        min-width: 60px;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-3 {
        gap: 1rem !important;
    }
}
</style>
{% endblock %}